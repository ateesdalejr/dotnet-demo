@model List<LegacyApp.Models.Order>
@* Report.cshtml - Sales Report
   This was supposed to be a whole reporting module with charts (ticket #3890)
   We got the table version working and then the project was "descoped"
   The Chart.js integration was attempted in 2020, abandoned after 2 days *@

<style>
    /* Report-specific styles - should be in CSS file but "it's just one page" */
    .report-stat { background: white; border: 1px solid #ddd; border-radius: 3px; padding: 20px; text-align: center; margin-bottom: 15px; }
    .report-stat h1 { font-size: 36px; margin: 0 0 5px 0; }
    .report-stat p { margin: 0; color: #7f8c8d; font-size: 11px; text-transform: uppercase; }
    .report-stat.revenue h1 { color: #27ae60; }
    .report-stat.orders h1 { color: #2980b9; }
    .report-stat.average h1 { color: #8e44ad; }
    .report-stat.largest h1 { color: #e67e22; }
    .status-table td, .status-table th { font-size: 12px; }
    .pct-bar { height: 18px; background-color: #3498db; border-radius: 2px; min-width: 2px; }
</style>

<h3 style="margin-top: 0; color: #2c3e50;">
    <i class="fa fa-bar-chart"></i> Sales Report
    <small style="color: #95a5a6;">| ACME Industrial Supply Co.</small>
</h3>

@* Date filter form *@
<div class="panel panel-legacy">
    <div class="panel-heading">
        <i class="fa fa-calendar"></i> Date Range
    </div>
    <div class="panel-body">
        <form method="get" action="/Home/Report" class="form-inline">
            <div class="form-group">
                <label>From:</label>
                <input type="date" name="startDate" class="form-control input-sm" value="@ViewBag.StartDate">
            </div>
            <div class="form-group" style="margin-left: 15px;">
                <label>To:</label>
                <input type="date" name="endDate" class="form-control input-sm" value="@ViewBag.EndDate">
            </div>
            <button type="submit" class="btn btn-acme btn-sm" style="margin-left: 15px;">
                <i class="fa fa-refresh"></i> Update Report
            </button>
            @* Quick date range buttons - hardcoded date math in JS *@
            <div class="btn-group" style="margin-left: 15px;">
                <button type="button" class="btn btn-default btn-sm" onclick="setDateRange(7)">Last 7 Days</button>
                <button type="button" class="btn btn-default btn-sm" onclick="setDateRange(30)">Last 30 Days</button>
                <button type="button" class="btn btn-default btn-sm" onclick="setDateRange(90)">Last 90 Days</button>
                <button type="button" class="btn btn-default btn-sm" onclick="setDateRange(365)">Last Year</button>
            </div>
        </form>
    </div>
</div>

@* Summary stats *@
<div class="row">
    <div class="col-md-3">
        <div class="report-stat orders">
            <h1>@ViewBag.TotalOrders</h1>
            <p>Total Orders</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="report-stat revenue">
            <h1>$@(((double)ViewBag.TotalRevenue).ToString("N0"))</h1>
            <p>Total Revenue</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="report-stat average">
            <h1>$@(((double)ViewBag.AvgOrder).ToString("N0"))</h1>
            <p>Average Order</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="report-stat largest">
            <h1>$@(((double)ViewBag.LargestOrder).ToString("N0"))</h1>
            <p>Largest Order</p>
        </div>
    </div>
</div>

<div class="row">
    @* Status breakdown *@
    <div class="col-md-4">
        <div class="panel panel-legacy">
            <div class="panel-heading"><i class="fa fa-pie-chart"></i> Orders by Status</div>
            @* Was supposed to be a pie chart - see ticket #3890 *@
            <table class="table table-condensed status-table" style="margin-bottom: 0;">
                <thead><tr><th>Status</th><th style="text-align:right;">Count</th><th style="text-align:right;">Revenue</th><th style="width:30%;">%</th></tr></thead>
                <tbody>
                @{
                    var statusBreakdown = (List<(string status, int count, double total)>)ViewBag.StatusBreakdown;
                    var maxTotal = statusBreakdown.Any() ? statusBreakdown.Max(s => s.total) : 1;
                }
                @foreach (var s in statusBreakdown)
                {
                    var pct = maxTotal > 0 ? (s.total / maxTotal * 100) : 0;
                    <tr>
                        <td>
                            <span class="label label-@(s.status == "Delivered" ? "success" : s.status == "Shipped" ? "info" : s.status == "Pending" ? "warning" : s.status == "Cancelled" ? "danger" : "default")">
                                @s.status
                            </span>
                        </td>
                        <td style="text-align: right;">@s.count</td>
                        <td style="text-align: right;" class="money">$@s.total.ToString("N0")</td>
                        <td><div class="pct-bar" style="width: @pct%"></div></td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    @* Top customers *@
    <div class="col-md-4">
        <div class="panel panel-legacy">
            <div class="panel-heading"><i class="fa fa-trophy"></i> Top Customers</div>
            <table class="table table-condensed status-table" style="margin-bottom: 0;">
                <thead><tr><th>Customer</th><th style="text-align:right;">Orders</th><th style="text-align:right;">Revenue</th></tr></thead>
                <tbody>
                @{
                    var topCustomers = (List<(string name, string company, int orders, double revenue)>)ViewBag.TopCustomers;
                }
                @foreach (var c in topCustomers)
                {
                    <tr>
                        <td>
                            <strong>@c.name</strong><br/>
                            <small style="color: #999;">@c.company</small>
                        </td>
                        <td style="text-align: right;">@c.orders</td>
                        <td style="text-align: right;" class="money">$@c.revenue.ToString("N0")</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    @* Top products *@
    <div class="col-md-4">
        <div class="panel panel-legacy">
            <div class="panel-heading"><i class="fa fa-star"></i> Top Products</div>
            <table class="table table-condensed status-table" style="margin-bottom: 0;">
                <thead><tr><th>Product</th><th style="text-align:right;">Qty Sold</th><th style="text-align:right;">Revenue</th></tr></thead>
                <tbody>
                @{
                    var topProducts = (List<(string name, string code, int qty, double sales)>)ViewBag.TopProducts;
                }
                @foreach (var p in topProducts)
                {
                    <tr>
                        <td>
                            <strong>@p.name</strong><br/>
                            <small><code>@p.code</code></small>
                        </td>
                        <td style="text-align: right;">@p.qty</td>
                        <td style="text-align: right;" class="money">$@p.sales.ToString("N0")</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* Orders table *@
<div class="panel panel-legacy">
    <div class="panel-heading">
        <i class="fa fa-list"></i> Recent Orders
        <span class="badge" style="background-color: #3498db;">@Model.Count</span>
    </div>
    <table class="table table-hover table-condensed" style="margin-bottom: 0; font-size: 12px;">
        <thead style="background-color: #f8f9fa;">
            <tr>
                <th>Order #</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Company</th>
                <th style="text-align:center;">Status</th>
                <th style="text-align:right;">Discount</th>
                <th style="text-align:right;">Subtotal</th>
                <th style="text-align:right;">Tax</th>
                <th style="text-align:right;">Total</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var o in Model)
            {
                <tr style="cursor: pointer;" onclick="viewOrder(@o.ORDER_ID)">
                    <td><strong>#@o.ORDER_ID</strong></td>
                    <td>@o.ORDER_DATE</td>
                    <td>@o.CustomerName</td>
                    <td>@o.CompanyName</td>
                    <td style="text-align:center;">
                        <span class="label label-@(o.Status == "Delivered" ? "success" : o.Status == "Shipped" ? "info" : o.Status == "Pending" ? "warning" : o.Status == "Cancelled" ? "danger" : "default")">
                            @o.Status
                        </span>
                    </td>
                    <td style="text-align: right;" class="money">
                        @if (o.DISCOUNT_PCT > 0) { <span style="color: #e74c3c;">@((o.DISCOUNT_PCT * 100).ToString("F0"))%</span> }
                    </td>
                    <td style="text-align: right;" class="money">$@o.SUBTOTAL.ToString("N2")</td>
                    <td style="text-align: right;" class="money">$@o.TAX_AMOUNT.ToString("N2")</td>
                    <td style="text-align: right;" class="money"><strong>$@o.TOTAL_AMOUNT.ToString("N2")</strong></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* Reuse order detail modal from index page - copied the whole thing because "partials are confusing" - contractor *@
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #2c3e50; color: white;">
                <button type="button" class="close" data-dismiss="modal" style="color: white;">&times;</button>
                <h4 class="modal-title"><i class="fa fa-file-text-o"></i> Order Details</h4>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <p>Loading...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Date range helper - same jQuery pattern from Index page, copy-pasted
    function setDateRange(days) {
        var end = new Date();
        var start = new Date();
        start.setDate(end.getDate() - days);
        // Format as YYYY-MM-DD - this manual formatting is fragile but "works"
        var startStr = start.getFullYear() + '-' + padZero(start.getMonth() + 1) + '-' + padZero(start.getDate());
        var endStr = end.getFullYear() + '-' + padZero(end.getMonth() + 1) + '-' + padZero(end.getDate());
        $('input[name=startDate]').val(startStr);
        $('input[name=endDate]').val(endStr);
        $('form').submit();
    }

    // Zero-pad function - should use a library but "it's just one function" (appears in 3 places)
    function padZero(n) {
        return n < 10 ? '0' + n : '' + n;
    }

    // Order detail viewer - DUPLICATED from Index.cshtml
    // Contractor copy-pasted it and said "we'll make it a shared script later"
    function viewOrder(orderId) {
        $('#orderDetailContent').html('<p style="text-align:center;"><i class="fa fa-spinner fa-spin"></i> Loading...</p>');
        $('#orderDetailModal').modal('show');

        $.getJSON('/Home/GetOrderDetails?id=' + orderId, function(data) {
            if (data.error) {
                $('#orderDetailContent').html('<p class="text-danger">Order not found.</p>');
                return;
            }

            var html = '<table class="table table-condensed" style="font-size: 12px;">';
            html += '<tr><td><strong>Order #</strong></td><td>' + data.orderId + '</td></tr>';
            html += '<tr><td><strong>Customer</strong></td><td>' + data.customerName + '</td></tr>';
            html += '<tr><td><strong>Company</strong></td><td>' + data.companyName + '</td></tr>';
            html += '<tr><td><strong>Date</strong></td><td>' + data.orderDate + '</td></tr>';
            html += '<tr><td><strong>Status</strong></td><td><span class="label label-' + getStatusColor(data.status) + '">' + data.status + '</span></td></tr>';
            if (data.shippingAddress) {
                html += '<tr><td><strong>Ship To</strong></td><td>' + data.shippingAddress + '</td></tr>';
            }
            html += '</table>';

            html += '<table class="table table-striped table-condensed" style="font-size: 12px;">';
            html += '<thead><tr><th>Product</th><th>Code</th><th>Qty</th><th style="text-align:right;">Price</th><th style="text-align:right;">Total</th></tr></thead><tbody>';
            for (var i = 0; i < data.details.length; i++) {
                var d = data.details[i];
                html += '<tr><td>' + d.productName + '</td><td><code>' + d.productCode + '</code></td><td>' + d.quantity + '</td><td style="text-align:right;" class="money">$' + d.unitPrice.toFixed(2) + '</td><td style="text-align:right;" class="money">$' + d.lineTotal.toFixed(2) + '</td></tr>';
            }
            html += '</tbody></table>';

            html += '<table class="table table-condensed" style="font-size: 12px; width: 250px; float: right;">';
            if (data.discountPct > 0) {
                html += '<tr><td>Discount:</td><td style="text-align:right;" class="money">' + (data.discountPct * 100).toFixed(0) + '%</td></tr>';
            }
            html += '<tr><td>Subtotal:</td><td style="text-align:right;" class="money">$' + data.subtotal.toFixed(2) + '</td></tr>';
            html += '<tr><td>Tax (8%):</td><td style="text-align:right;" class="money">$' + data.taxAmount.toFixed(2) + '</td></tr>';
            html += '<tr style="font-weight:bold; font-size:14px;"><td>Total:</td><td style="text-align:right;" class="money">$' + data.totalAmount.toFixed(2) + '</td></tr>';
            html += '</table><div style="clear:both;"></div>';

            if (data.notes) {
                html += '<p style="margin-top:10px; font-style:italic; color:#666;"><strong>Notes:</strong> ' + data.notes + '</p>';
            }

            $('#orderDetailContent').html(html);
        });
    }

    function getStatusColor(status) {
        switch(status) {
            case 'Delivered': return 'success';
            case 'Shipped': return 'info';
            case 'Approved': return 'primary';
            case 'Pending': return 'warning';
            case 'Procesing': return 'warning';
            case 'Cancelled': return 'danger';
            default: return 'default';
        }
    }
</script>
}
