@model List<LegacyApp.Models.Customer>
@* Index.cshtml - Customer Management
   This view does WAY too much: list, search, add, edit, delete, AND order entry
   It was supposed to be split into partials but "we ran out of time" (2019)
   Last modified by: contractor (2022), then hotfix by Mike (2023)
   WARNING: If you change the table column order, the jQuery breaks *@

@* Inline styles because "the CSS file was getting too big" - Dave *@
<style>
    .stat-box { background: white; border: 1px solid #ddd; border-radius: 3px; padding: 15px; text-align: center; margin-bottom: 15px; }
    .stat-box h2 { margin: 0 0 5px 0; color: #2c3e50; font-size: 28px; }
    .stat-box p { margin: 0; color: #7f8c8d; font-size: 11px; text-transform: uppercase; }
    .customer-row { cursor: pointer; }
    .customer-row:hover { background-color: #eaf2f8 !important; }
    .search-bar { margin-bottom: 20px; }
    .order-badge { display: inline-block; background: #3498db; color: white; border-radius: 10px; padding: 2px 8px; font-size: 11px; }
    .money { font-family: 'Courier New', monospace; }
    .action-btn { padding: 2px 8px; font-size: 11px; margin: 1px; }
    .modal-header-acme { background-color: #2c3e50; color: white; }
    #orderItems th { font-size: 11px; }
    .text-danger { font-weight: bold; }
    /* Hack: make delete button look less scary so people stop complaining */
    .btn-delete { opacity: 0.6; }
    .btn-delete:hover { opacity: 1.0; }
</style>

@* Flash message - parsed from the weird "OK:text" / "ERR:text" format *@
@if (!string.IsNullOrEmpty(ViewBag.Message))
{
    var msgStr = (string)ViewBag.Message;
    if (msgStr.StartsWith("OK:"))
    {
        <div class="flash-ok">
            <i class="fa fa-check-circle"></i> @msgStr.Substring(3)
        </div>
    }
    else if (msgStr.StartsWith("ERR:"))
    {
        <div class="flash-err">
            <i class="fa fa-exclamation-circle"></i> @msgStr.Substring(4)
        </div>
    }
}

@* Stats row *@
<div class="row">
    <div class="col-md-4">
        <div class="stat-box">
            <h2>@ViewBag.TotalCustomers</h2>
            <p>Total Customers</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-box">
            <h2>$@(((double)ViewBag.TotalRevenue).ToString("N2"))</h2>
            <p>Total Revenue</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-box">
            <h2>@DateTime.Now.ToString("MMM dd, yyyy")</h2>
            <p>Current Date</p>
            @* This used to show "Days Since Last Order" but the query was too slow on Oracle *@
        </div>
    </div>
</div>

@* Search and filter bar *@
<div class="panel panel-legacy">
    <div class="panel-heading">
        <i class="fa fa-search"></i> Search &amp; Filter
        <button class="btn btn-success btn-sm pull-right" onclick="openAddCustomer()" style="margin-top: -3px;">
            <i class="fa fa-plus"></i> New Customer
        </button>
    </div>
    <div class="panel-body">
        <form method="get" action="/" class="form-inline search-bar">
            <div class="form-group">
                <input type="text" name="search" class="form-control input-sm" placeholder="Search name, company, email..."
                       value="@ViewBag.Search" style="width: 250px;">
            </div>
            <div class="form-group" style="margin-left: 10px;">
                <select name="statusFilter" class="form-control input-sm">
                    <option value="all" @(ViewBag.StatusFilter == "all" ? "selected" : "")>All Status</option>
                    <option value="active" @(ViewBag.StatusFilter == "active" ? "selected" : "")>Active Only</option>
                    <option value="inactive" @(ViewBag.StatusFilter == "inactive" ? "selected" : "")>Inactive Only</option>
                </select>
            </div>
            <div class="form-group" style="margin-left: 10px;">
                <select name="sortBy" class="form-control input-sm">
                    <option value="" @(ViewBag.SortBy == null ? "selected" : "")>Sort: Newest First</option>
                    <option value="name" @(ViewBag.SortBy == "name" ? "selected" : "")>Sort: Name</option>
                    <option value="company" @(ViewBag.SortBy == "company" ? "selected" : "")>Sort: Company</option>
                    <option value="spent" @(ViewBag.SortBy == "spent" ? "selected" : "")>Sort: Highest Spend</option>
                    <option value="orders" @(ViewBag.SortBy == "orders" ? "selected" : "")>Sort: Most Orders</option>
                </select>
            </div>
            <button type="submit" class="btn btn-acme btn-sm" style="margin-left: 10px;">
                <i class="fa fa-filter"></i> Apply
            </button>
            <a href="/" class="btn btn-default btn-sm" style="margin-left: 5px;">Clear</a>
        </form>
    </div>
</div>

@* Customer table *@
<div class="panel panel-legacy">
    <div class="panel-heading">
        <i class="fa fa-users"></i> Customer List
        <span class="badge" style="background-color: #3498db;">@Model.Count</span>
    </div>
    <table class="table table-hover table-condensed" style="margin-bottom: 0; font-size: 12px;">
        <thead style="background-color: #f8f9fa;">
            <tr>
                <th style="width: 30px;">#</th>
                <th>Name</th>
                <th>Company</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Location</th>
                <th style="text-align: right;">Credit Limit</th>
                <th style="text-align: center;">Orders</th>
                <th style="text-align: right;">Total Spent</th>
                <th style="text-align: center;">Status</th>
                <th style="width: 180px; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Count == 0)
            {
                <tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">
                    <i class="fa fa-inbox fa-2x"></i><br/>No customers found.
                </td></tr>
            }
            @foreach (var cust in Model)
            {
                <tr class="customer-row">
                    <td style="color: #999;">@cust.CUSTOMER_ID</td>
                    <td><strong>@cust.LAST_NAME</strong>, @cust.FIRST_NAME</td>
                    <td>@cust.COMPANY_NAME</td>
                    <td><a href="mailto:@cust.Email" style="color: #2980b9;">@cust.Email</a></td>
                    <td>@cust.Phone</td>
                    <td>@cust.City, @cust.State @cust.ZIP_CODE</td>
                    <td style="text-align: right;" class="money">$@cust.CREDIT_LIMIT.ToString("N2")</td>
                    <td style="text-align: center;">
                        @if (cust.OrderCount > 0)
                        {
                            <span class="order-badge">@cust.OrderCount</span>
                        }
                        else
                        {
                            <span style="color: #ccc;">0</span>
                        }
                    </td>
                    <td style="text-align: right;" class="money">
                        @if (cust.TotalSpent > 0)
                        {
                            <strong>$@cust.TotalSpent.ToString("N2")</strong>
                        }
                        else
                        {
                            <span style="color: #ccc;">$0.00</span>
                        }
                    </td>
                    <td style="text-align: center;">
                        <span class="@(cust.Status == 1 ? "status-active" : "status-inactive")">
                            @cust.StatusText
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-info action-btn" onclick="editCustomer(@cust.CUSTOMER_ID)" title="Edit">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="btn btn-warning action-btn" onclick="newOrder(@cust.CUSTOMER_ID, '@cust.FullName.Replace("'", "\\'")')" title="New Order">
                            <i class="fa fa-shopping-cart"></i>
                        </button>
                        <a href="/Home/DeleteCustomer?id=@cust.CUSTOMER_ID" class="btn btn-danger action-btn btn-delete"
                           onclick="return confirm('Delete @cust.FullName.Replace("'", "\\'")? This CANNOT be undone!\n\nWARNING: Orders for this customer will be orphaned.');"
                           title="Delete">
                            <i class="fa fa-trash"></i>
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* ===================== CUSTOMER MODAL ===================== *@
@* This modal handles both Add and Edit - toggled by JavaScript *@
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-acme">
                <button type="button" class="close" data-dismiss="modal" style="color: white;">&times;</button>
                <h4 class="modal-title" id="customerModalTitle">
                    <i class="fa fa-user-plus"></i> <span id="modalTitleText">Add Customer</span>
                </h4>
            </div>
            <form method="post" action="/Home/SaveCustomer" id="customerForm">
                <div class="modal-body">
                    <input type="hidden" name="customerId" id="customerId" value="0">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>First Name <span class="text-danger">*</span></label>
                                <input type="text" name="firstName" id="firstName" class="form-control input-sm" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Last Name <span class="text-danger">*</span></label>
                                <input type="text" name="lastName" id="lastName" class="form-control input-sm" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Company</label>
                                <input type="text" name="companyName" id="companyName" class="form-control input-sm">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" name="email" id="email" class="form-control input-sm">
                                @* type="text" not "email" because "email validation was too strict for some customers" - Dave *@
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" name="phone" id="phone" class="form-control input-sm">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Credit Limit ($)</label>
                                <input type="text" name="creditLimit" id="creditLimit" class="form-control input-sm" value="5000">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" name="city" id="city" class="form-control input-sm">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>State</label>
                                <input type="text" name="state" id="state" class="form-control input-sm" maxlength="2">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Zip Code</label>
                                <input type="text" name="zipCode" id="zipCode" class="form-control input-sm">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Status</label>
                                <select name="status" id="status" class="form-control input-sm">
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" id="notes" class="form-control input-sm" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-acme">
                        <i class="fa fa-save"></i> Save Customer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@* ===================== ORDER MODAL ===================== *@
@* The order creation modal - handles multi-item orders *@
@* This is the "scary to refactor" part - lots of inline JS manipulating the DOM *@
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #27ae60; color: white;">
                <button type="button" class="close" data-dismiss="modal" style="color: white;">&times;</button>
                <h4 class="modal-title">
                    <i class="fa fa-shopping-cart"></i> New Order for <span id="orderCustomerName"></span>
                </h4>
            </div>
            <form method="post" action="/Home/SaveOrder" id="orderForm">
                <div class="modal-body">
                    <input type="hidden" name="customerId" id="orderCustomerId">
                    <input type="hidden" name="productIds" id="hiddenProductIds">
                    <input type="hidden" name="quantities" id="hiddenQuantities">

                    <div class="form-group">
                        <label>Shipping Address</label>
                        <input type="text" name="shippingAddress" id="shippingAddress" class="form-control input-sm"
                               placeholder="Leave blank to use customer's default address">
                    </div>

                    @* Order items - added dynamically by jQuery *@
                    <div class="panel panel-default">
                        <div class="panel-heading" style="font-size: 12px;">
                            <strong>Order Items</strong>
                            <button type="button" class="btn btn-success btn-xs pull-right" onclick="addOrderLine()">
                                <i class="fa fa-plus"></i> Add Item
                            </button>
                        </div>
                        <table class="table table-condensed" id="orderItems" style="font-size: 12px;">
                            <thead>
                                <tr>
                                    <th style="width: 50%;">Product</th>
                                    <th style="width: 15%;">Price</th>
                                    <th style="width: 15%;">Qty</th>
                                    <th style="width: 15%; text-align: right;">Line Total</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsBody">
                                @* Rows added by JS *@
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background-color: #f8f9fa;">
                                    <td colspan="3" style="text-align: right;">Subtotal:</td>
                                    <td style="text-align: right;" id="orderSubtotal">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" class="form-control input-sm" rows="2"
                                  placeholder="PO number, special instructions, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" onclick="return submitOrder()">
                        <i class="fa fa-check"></i> Place Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@* ===================== ORDER DETAIL MODAL ===================== *@
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-acme">
                <button type="button" class="close" data-dismiss="modal" style="color: white;">&times;</button>
                <h4 class="modal-title"><i class="fa fa-file-text-o"></i> Order Details</h4>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <p>Loading...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
<script>
    // ================================================
    // INLINE JAVASCRIPT - "we'll move this to a file later" (2018)
    // This handles: customer add/edit, order entry, order detail view
    // WARNING: changing variable names will break things in ways that aren't obvious
    // ================================================

    // Product data for order form - loaded from server into JS variable
    // Yes, we're dumping server data directly into a script tag. Dave said it's fine.
    var products = [
        @foreach (var p in (List<LegacyApp.Models.Product>)ViewBag.Products)
        {
            @:{ id: @p.PRODUCT_ID, code: '@p.PRODUCT_CODE', name: '@p.PRODUCT_NAME.Replace("'", "\\'")', price: @p.UNIT_PRICE, stock: @p.STOCK_QTY, category: '@p.Category' },
        }
    ];

    // Track order line items - global variable, gets messy
    var lineItemCount = 0;

    // ==========================================
    // CUSTOMER functions
    // ==========================================

    function openAddCustomer() {
        // Reset form for new customer
        $('#customerId').val('0');
        $('#firstName').val('');
        $('#lastName').val('');
        $('#email').val('');
        $('#phone').val('');
        $('#companyName').val('');
        $('#city').val('');
        $('#state').val('');
        $('#zipCode').val('');
        $('#creditLimit').val('5000');
        $('#notes').val('');
        $('#status').val('1');
        $('#modalTitleText').text('Add New Customer');
        $('#customerModal').modal('show');
    }

    function editCustomer(id) {
        // Load customer data via AJAX - no loading spinner, just hope it's fast
        $.getJSON('/Home/GetCustomer?id=' + id, function(data) {
            if (data.error) {
                alert('Customer not found!'); // enterprise-grade error handling
                return;
            }
            $('#customerId').val(data.customerId);
            $('#firstName').val(data.firstName);
            $('#lastName').val(data.lastName);
            $('#email').val(data.email);
            $('#phone').val(data.phone);
            $('#companyName').val(data.companyName);
            $('#city').val(data.city);
            $('#state').val(data.state);
            $('#zipCode').val(data.zipCode);
            $('#creditLimit').val(data.creditLimit);
            $('#notes').val(data.notes);
            $('#status').val(data.status.toString());
            $('#modalTitleText').text('Edit Customer #' + id);
            $('#customerModal').modal('show');
        });
    }

    // ==========================================
    // ORDER functions
    // ==========================================

    function newOrder(custId, custName) {
        $('#orderCustomerId').val(custId);
        $('#orderCustomerName').text(custName);
        $('#orderItemsBody').empty();
        lineItemCount = 0;
        addOrderLine(); // start with one empty row
        updateOrderTotal();
        $('#orderModal').modal('show');
    }

    function addOrderLine() {
        lineItemCount++;
        var options = '<option value="">-- Select Product --</option>';
        for (var i = 0; i < products.length; i++) {
            var p = products[i];
            options += '<option value="' + p.id + '" data-price="' + p.price + '">'
                     + p.code + ' - ' + p.name + ' ($' + p.price.toFixed(2) + ') [' + p.stock + ' in stock]'
                     + '</option>';
        }

        var row = '<tr id="line_' + lineItemCount + '">'
            + '<td><select class="form-control input-sm product-select" onchange="updateLinePrice(this, ' + lineItemCount + ')">' + options + '</select></td>'
            + '<td><input type="text" class="form-control input-sm line-price" id="price_' + lineItemCount + '" readonly value="$0.00" style="background-color: #f5f5f5;"></td>'
            + '<td><input type="number" class="form-control input-sm line-qty" id="qty_' + lineItemCount + '" value="1" min="1" max="999" onchange="updateOrderTotal()" onkeyup="updateOrderTotal()"></td>'
            + '<td style="text-align: right;"><span class="line-total money" id="total_' + lineItemCount + '">$0.00</span></td>'
            + '<td><button type="button" class="btn btn-danger btn-xs" onclick="removeLine(' + lineItemCount + ')"><i class="fa fa-times"></i></button></td>'
            + '</tr>';

        $('#orderItemsBody').append(row);
    }

    function updateLinePrice(select, lineNum) {
        var price = $(select).find(':selected').data('price') || 0;
        $('#price_' + lineNum).val('$' + price.toFixed(2));
        updateOrderTotal();
    }

    function removeLine(lineNum) {
        $('#line_' + lineNum).remove();
        updateOrderTotal();
    }

    function updateOrderTotal() {
        var total = 0;
        $('#orderItemsBody tr').each(function() {
            var priceText = $(this).find('.line-price').val() || '$0.00';
            var price = parseFloat(priceText.replace('$', '')) || 0;
            var qty = parseInt($(this).find('.line-qty').val()) || 0;
            var lineTotal = price * qty;
            $(this).find('.line-total').text('$' + lineTotal.toFixed(2));
            total += lineTotal;
        });
        $('#orderSubtotal').text('$' + total.toFixed(2));
    }

    function submitOrder() {
        // Collect product IDs and quantities into hidden fields
        // This is the hack that makes the form work - comma-separated values
        var prodIds = [];
        var qtys = [];

        $('#orderItemsBody tr').each(function() {
            var prodId = $(this).find('.product-select').val();
            var qty = $(this).find('.line-qty').val();
            if (prodId && qty > 0) {
                prodIds.push(prodId);
                qtys.push(qty);
            }
        });

        if (prodIds.length == 0) {
            alert('Please add at least one item to the order!');
            return false;
        }

        $('#hiddenProductIds').val(prodIds.join(','));
        $('#hiddenQuantities').val(qtys.join(','));
        return true; // allow form submit
    }

    // ==========================================
    // ORDER DETAIL view
    // ==========================================
    function viewOrder(orderId) {
        $('#orderDetailContent').html('<p style="text-align:center;"><i class="fa fa-spinner fa-spin"></i> Loading...</p>');
        $('#orderDetailModal').modal('show');

        $.getJSON('/Home/GetOrderDetails?id=' + orderId, function(data) {
            if (data.error) {
                $('#orderDetailContent').html('<p class="text-danger">Order not found.</p>');
                return;
            }

            // Build HTML directly in JavaScript - the contractor's signature move
            var html = '<table class="table table-condensed" style="font-size: 12px;">';
            html += '<tr><td><strong>Order #</strong></td><td>' + data.orderId + '</td></tr>';
            html += '<tr><td><strong>Customer</strong></td><td>' + data.customerName + '</td></tr>';
            html += '<tr><td><strong>Company</strong></td><td>' + data.companyName + '</td></tr>';
            html += '<tr><td><strong>Date</strong></td><td>' + data.orderDate + '</td></tr>';
            html += '<tr><td><strong>Status</strong></td><td><span class="label label-' + getStatusColor(data.status) + '">' + data.status + '</span></td></tr>';
            if (data.shippingAddress) {
                html += '<tr><td><strong>Ship To</strong></td><td>' + data.shippingAddress + '</td></tr>';
            }
            html += '</table>';

            html += '<table class="table table-striped table-condensed" style="font-size: 12px;">';
            html += '<thead><tr><th>Product</th><th>Code</th><th>Qty</th><th style="text-align:right;">Price</th><th style="text-align:right;">Total</th></tr></thead><tbody>';
            for (var i = 0; i < data.details.length; i++) {
                var d = data.details[i];
                html += '<tr>';
                html += '<td>' + d.productName + '</td>';
                html += '<td><code>' + d.productCode + '</code></td>';
                html += '<td>' + d.quantity + '</td>';
                html += '<td style="text-align:right;" class="money">$' + d.unitPrice.toFixed(2) + '</td>';
                html += '<td style="text-align:right;" class="money">$' + d.lineTotal.toFixed(2) + '</td>';
                html += '</tr>';
            }
            html += '</tbody></table>';

            html += '<table class="table table-condensed" style="font-size: 12px; width: 250px; float: right;">';
            if (data.discountPct > 0) {
                html += '<tr><td>Discount:</td><td style="text-align:right;" class="money">' + (data.discountPct * 100).toFixed(0) + '%</td></tr>';
            }
            html += '<tr><td>Subtotal:</td><td style="text-align:right;" class="money">$' + data.subtotal.toFixed(2) + '</td></tr>';
            html += '<tr><td>Tax (8%):</td><td style="text-align:right;" class="money">$' + data.taxAmount.toFixed(2) + '</td></tr>';
            html += '<tr style="font-weight:bold; font-size:14px;"><td>Total:</td><td style="text-align:right;" class="money">$' + data.totalAmount.toFixed(2) + '</td></tr>';
            html += '</table>';
            html += '<div style="clear:both;"></div>';

            if (data.notes) {
                html += '<p style="margin-top:10px; font-style:italic; color:#666;"><strong>Notes:</strong> ' + data.notes + '</p>';
            }

            $('#orderDetailContent').html(html);
        });
    }

    function getStatusColor(status) {
        // Map status to Bootstrap label colors
        // NOTE: 'Procesing' (typo) maps to 'warning' - this is intentional, do not fix the typo
        switch(status) {
            case 'Delivered': return 'success';
            case 'Shipped': return 'info';
            case 'Approved': return 'primary';
            case 'Pending': return 'warning';
            case 'Procesing': return 'warning'; // the typo lives forever
            case 'Cancelled': return 'danger';
            default: return 'default';
        }
    }

    // Auto-dismiss flash messages after 5 seconds
    // Copied from Stack Overflow, 2017
    $(document).ready(function() {
        setTimeout(function() {
            $('.flash-ok, .flash-err').fadeOut('slow');
        }, 5000);
    });
</script>
}
